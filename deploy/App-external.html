<!DOCTYPE html>
<html>
<head>
    <title>TestResultsLog</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn",cls:"export-button"},{xtype:"container",itemId:"buildCombobox",cls:"build-combo-box"},{xtype:"container",itemId:"vistaBuildCombobox",cls:"vista-build-combo-box"},{xtype:"container",itemId:"environmentCombobox",cls:"environment-combo-box"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),Ext.define("MyRally.util.Filter",{override:"Ext.util.Filter",statics:{createFilterFn:function(filters){return filters&&filters.length?function(candidate){var isMatch=!0,length=filters.length,i,filter;for(i=0;isMatch&&length>i;i++)filter=filters[i],!filter.disabled&&filter.filterFn&&(isMatch=isMatch&&filter.filterFn.call(filter.scope||filter,candidate));return isMatch}:function(){return!0}}}}),this.down("#environmentCombobox").add({xtype:"rallyfieldvaluecombobox",itemId:"environmentComboBox",model:"TestCaseResult",field:"c_PhysicalEnvironment",value:"FIT",listeners:{scope:this,select:this._onEnvironmentSelect,ready:this._initStore}})},_getEnvironmentFilter:function(){return{property:"Environment",operator:"=",value:this.down("#environmentComboBox").getRawValue()}},_onEnvironmentSelect:function(){var store=this._grid.getStore();store.clearFilter(!0),store.filter(this._getEnvironmentFilter())},_initStore:function(){this._defectsStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","State","TestCase"],limit:1/0}),this._defectsStore.on("load",function(){this._testCaseStore=Ext.create("Rally.data.wsapi.Store",{model:"TestCase",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","Type","WorkProduct","Milestones","Defects","Results"],limit:1/0}),this._testCaseStore.on("load",function(){Ext.create("Rally.data.wsapi.Store",{model:"TestCaseResult",autoLoad:!0,remoteSort:!1,fetch:["Build","Date","TestCase","Tester","Verdict","c_PhysicalEnvironment","c_VistABuild","c_VistAInstance"],limit:1/0,listeners:{load:this._onDataLoaded,scope:this}})},this)},this)},_onDataLoaded:function(store,data){_.each(data,function(testresult){testresult.set("TesterName",testresult.data.Tester._refObjectName),testresult.set("Environment",testresult.data.c_PhysicalEnvironment),_.each(this._testCaseStore.data.items,function(testcase){if(testcase.data._ref===testresult.data.TestCase._ref&&(testresult.set("TestCase",testcase),testresult.set("TestCaseNumericID",Number(testcase.data.FormattedID.replace(/\D+/g,""))),testresult.set("TestCaseName",testcase.data.Name),testresult.set("TestCaseType",testcase.data.Type),testresult.set("TestCaseWorkProduct",testcase.data.WorkProduct),testcase.data.WorkProduct&&testresult.set("TestCaseWorkProductNumericID",Number(testcase.data.WorkProduct.FormattedID.replace(/\D+/g,""))),testcase.data.Defects&&testcase.data.Defects.Count>0)){var allDefectHtml=[],openDefectHtml=[];_.each(this._defectsStore.data.items,function(defect){defect.data.TestCase&&defect.data.TestCase.FormattedID===testcase.data.FormattedID&&(allDefectHtml.push('<a href="'+Rally.nav.Manager.getDetailUrl(defect)+'" target="_blank">'+defect.data.FormattedID+"</a> - "+defect.data.State),"Closed"!==defect.data.State&&"VA-Awaiting Closure"!==defect.data.State&&"Awaiting Information from VA"!==defect.data.State&&"Awaiting CCB Decision"!==defect.data.State&&"Deferred"!==defect.data.State&&openDefectHtml.push('<a href="'+Rally.nav.Manager.getDetailUrl(defect)+'" target="_blank">'+defect.data.FormattedID+"</a>"))},this),testresult.set("AllDefects",allDefectHtml.join("</br>")),testresult.set("OpenDefects",openDefectHtml.join("</br>"))}},this)},this),this._makeGrid(data),this._onEnvironmentSelect()},_makeGrid:function(testcases){this._myMask.hide();var store=Ext.create("Rally.data.custom.Store",{data:testcases,storeId:"customStore",proxy:{type:"memory"}});this._testcases=testcases,this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"testcasesGrid",store:store,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:[{text:"Test Case ID",dataIndex:"TestCase",renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.data.FormattedID+"</a>":void 0},getSortParam:function(){return"TestCaseNumericID"}},{text:"Test Case Name",dataIndex:"TestCaseName",flex:1},{text:"Test Case Type",dataIndex:"TestCaseType"},{text:"Work Product ID",dataIndex:"TestCaseWorkProduct",renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.FormattedID+"</a>":void 0},getSortParam:function(){return"TestCaseWorkProductNumericID"}},{text:"Test Results Build",dataIndex:"Build"},{text:"Test Results Date",dataIndex:"Date",xtype:"datecolumn",format:"D n/j/Y"},{text:"Test Results Tester",dataIndex:"TesterName"},{text:"Test Results Verdict",dataIndex:"Verdict",sortable:!1},{text:"Test Results Physical Environment",dataIndex:"c_PhysicalEnvironment"},{text:"Test Results VistA Build",dataIndex:"c_VistABuild"},{text:"Test Results VistA Instance",dataIndex:"c_VistAInstance"},{text:"Defects",dataIndex:"AllDefects"},{text:"Open Defects",dataIndex:"OpenDefects"}]});var thisRef=this;this.down("#buildCombobox").add({store:store,xtype:"rallysearchcombobox",itemId:"buildCombobox",model:"TestCaseResult",valueField:"Build",hideTrigger:!0,noEntryText:"",emptyText:"Filter By Build",autoSelect:!1,submitEmptyText:!1,forceSelection:!1,clearFilterOnBlur:!1,anyMatch:!0,queryMode:"local",submitValue:!1,listeners:{keyup:function(self,event){13===event.keyCode&&(this.getRawValue()&&""!==this.getRawValue()&&"All Builds"!==this.getRawValue()?(this.store.clearFilter(!0),"All VistA Builds"!==thisRef.down("#vistaBuildCombobox").items.items[0].getRawValue()?this.store.filter([thisRef._getBuildFilter(),thisRef._getVistaBuildFilter(),thisRef._getEnvironmentFilter()]):this.store.filter([thisRef._getBuildFilter(),thisRef._getEnvironmentFilter()])):this.store.clearFilter(!0))}}}),this.down("#vistaBuildCombobox").add({store:store,xtype:"rallysearchcombobox",itemId:"vistaBuildCombobox",model:"TestCaseResult",valueField:"c_VistABuild",hideTrigger:!0,noEntryText:"",emptyText:"Filter By VistA Build",autoSelect:!1,submitEmptyText:!1,forceSelection:!1,clearFilterOnBlur:!1,anyMatch:!0,queryMode:"local",submitValue:!1,listeners:{keyup:function(self,event){13===event.keyCode&&(this.getRawValue()&&""!==this.getRawValue()&&"All VistA Builds"!==this.getRawValue()?(this.store.clearFilter(!0),this.store.filter([thisRef._getVistaBuildFilter(),thisRef._getEnvironmentFilter()])):this.store.clearFilter(!0))}}}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",href:"data:text/csv;charset=utf8,"+encodeURIComponent(this._getCSV()),id:"exportButton",scope:this}),document.getElementById("exportButton").setAttribute("download","export.csv")},_getBuildFilter:function(){return{property:"Build",value:this.down("#buildCombobox").items.items[0].getRawValue()}},_getVistaBuildFilter:function(){return{property:"c_VistABuild",value:this.down("#vistaBuildCombobox").items.items[0].getRawValue()}},_getCSV:function(){var cols=this._grid.columns,data="";return _.each(cols,function(col){data+=this._getFieldTextAndEscape(col.text)+","},this),data+="\r\n",_.each(this._testcases,function(record){_.each(cols,function(col){var fieldName=col.dataIndex;if("WorkProduct"===fieldName&&record.data.WorkProduct)data+=this._getFieldTextAndEscape(record.data.WorkProduct.FormattedID)+",";else if("TestCase"===fieldName)data+=this._getFieldTextAndEscape(record.data.TestCase.data.FormattedID)+",";else if("LastRun"===fieldName){var lastRunText="";record.data.LastRun&&(lastRunText=""+record.data.LastRun),data+=this._getFieldTextAndEscape(lastRunText)+","}else if("AllDefects"===fieldName&&record.data.AllDefects){var text='"';_.each(this._defectsStore.data.items,function(defect){defect.data.TestCase&&defect.data.TestCase.FormattedID===record.data.TestCase.data.FormattedID&&(text+=defect.data.FormattedID+" - "+defect.data.State+"\n")},this),text+='"',data+=text+","}else if("OpenDefects"===fieldName&&record.data.OpenDefects){var openDefectText='"';_.each(this._defectsStore.data.items,function(defect){defect.data.TestCase&&defect.data.TestCase.FormattedID===record.data.TestCase.data.FormattedID&&"Closed"!==defect.data.State&&"VA-Awaiting Closure"!==defect.data.State&&"Awaiting Information from VA"!==defect.data.State&&"Awaiting CCB Decision"!==defect.data.State&&"Deferred"!==defect.data.State&&(openDefectText+=defect.data.FormattedID+"\n")},this),openDefectText+='"',data+=openDefectText+","}else data+="Date"===fieldName?this._getFieldTextAndEscape(""+record.data.Date)+",":"TestCaseWorkProduct"===fieldName&&record.data.TestCaseWorkProduct?this._getFieldTextAndEscape(record.data.TestCaseWorkProduct.FormattedID)+",":this._getFieldTextAndEscape(record.get(fieldName))+","},this),data+="\r\n"},this),data},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"TestResultsLog",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .export-button{display:inline;float:right;width:100px}.build-combo-box{display:inline;float:left;width:160px}.vista-build-combo-box{display:inline;float:left;width:160px}.environment-combo-box{display:inline;float:left;width:160px}.x-panel-body{height:auto !important}.x-panel-default{height:auto !important}.rui-triggerfield .x-form-field{border-right-width:1px}.rui-triggerfield:hover .x-form-field{border-right-width:1px}
    </style>
</head>
<body>
</body>
</html>
